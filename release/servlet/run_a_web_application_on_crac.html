<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 2.0.0-M19 from src/site/markdown/servlet/run_a_web_application_on_crac.md at 2024-09-13
 | Rendered using Apache Maven Fluido Skin 2.0.0-M10
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 2.0.0-M19" />
    <title>Run a web application on CRaC – Piranha</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-2.0.0-M10.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-2.0.0-M10.min.js"></script>
    <style>.github-fork-ribbon:before { background-color: black; }</style>
  </head>
  <body>
    <a class="github-fork-ribbon left-bottom fixed" href="https://github.com/piranhacloud/piranha" data-ribbon="Fork me on GitHub">Fork me on GitHub</a>
    <div class="container-fluid container-fluid-top">
      <header>
        <div id="banner">
          <div class="pull-left"><div id="bannerLeft"><h1><a href="https://piranha.cloud/" class="externalLink">Piranha</a></h1></div></div>
          <div class="pull-right"><div id="bannerRight"><h1>A cloud native extensible runtime</h1></div></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="projectVersion">Version: 24.9.0-SNAPSHOT</li>
        <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2024-09-13</li>
        <li class="pull-right"><span class="divider">|</span>
<a href="../webprofile/index.html">Web Profile</a></li>
        <li class="pull-right"><span class="divider">|</span>
<a href="../servlet/index.html">Servlet</a></li>
        <li class="pull-right"><span class="divider">|</span>
<a href="../server/index.html">Server</a></li>
        <li class="pull-right"><span class="divider">|</span>
<a href="../micro/index.html">Micro</a></li>
        <li class="pull-right"><span class="divider">|</span>
<a href="../embedded/index.html">Embedded</a></li>
        <li class="pull-right"><a href="../coreprofile/index.html">Core Profile</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Overview</li>
    <li><a href="../index.html">Getting Started</a></li>
   <li class="nav-header">Piranha Core Profile</li>
    <li><a href="../coreprofile/index.html">Overview</a></li>
    <li><a><span class="icon-chevron-down"></span>Guides</a>
     <ul class="nav nav-list">
      <li><a href="../coreprofile/create_a_rest_service.html">Create a REST service</a></li>
      <li><a href="../coreprofile/create_a_json_rest_service.html">Create a JSON REST service</a></li>
      <li><a href="../coreprofile/debugging_a_rest_service_with_netbeans.html">Debugging a REST service with NetBeans</a></li>
      <li><a href="../coreprofile/debugging_a_rest_service_with_vscode.html">Debugging a REST service with VSCode</a></li>
      <li><a href="../coreprofile/testing_with_junit5_and_arquillian.html">Testing with JUnit 5 and Arquillian</a></li>
      <li><a href="../coreprofile/using_project_crac.html">Using Project CRaC</a></li>
     </ul></li>
   <li class="nav-header">Piranha Embedded</li>
    <li><a href="../embedded/index.html">Overview</a></li>
    <li><a><span class="icon-chevron-down"></span>Guides</a>
     <ul class="nav nav-list">
      <li><a href="../embedded/create_a_piranha_embedded_graalvm_application.html">Create a Piranha Embedded GraalVM application</a></li>
      <li><a href="../embedded/create_a_hello_world_web_application.html">Create a Hello World web application</a></li>
      <li><a href="../embedded/create_an_embedded_jlink_application.html">Create an embedded JLink application</a></li>
      <li><a href="../embedded/running_piranha_embedded_with_spring_boot.html">Running Piranha Embedded with Spring Boot</a></li>
     </ul></li>
   <li class="nav-header">Piranha Micro</li>
    <li><a href="../micro/index.html">Overview</a></li>
    <li><a><span class="icon-chevron-down"></span>Guides</a>
     <ul class="nav nav-list">
      <li><a href="../micro/create_a_hello_world_web_application.html">Create a Hello World web application</a></li>
     </ul></li>
   <li class="nav-header">Piranha Server</li>
    <li><a href="../server/index.html">Overview</a></li>
    <li><a><span class="icon-chevron-down"></span>Guides</a>
     <ul class="nav nav-list">
      <li><a href="../server/create_a_hello_world_web_application.html">Create a Hello World web application</a></li>
     </ul></li>
   <li class="nav-header">Piranha Servlet</li>
    <li><a href="../servlet/index.html">Overview</a></li>
    <li><a><span class="icon-chevron-down"></span>Guides</a>
     <ul class="nav nav-list">
      <li><a href="../servlet/create_a_faces_application.html">Create a Faces application</a></li>
      <li><a href="../servlet/create_a_hello_world_web_application.html">Create a Hello World web application</a></li>
      <li><a href="../servlet/create_jakarta_pages_application.html">Create a Jakarta Pages application</a></li>
      <li><a href="../servlet/create_a_websocket_application.html">Create a WebSocket application</a></li>
      <li class="active"><a>Run a web application on CRaC</a></li>
     </ul></li>
   <li class="nav-header">Piranha Web Profile</li>
    <li><a href="../webprofile/index.html">Overview</a></li>
    <li><a><span class="icon-chevron-down"></span>Guides</a>
     <ul class="nav nav-list">
      <li><a href="../webprofile/create_a_faces_application.html">Create a Faces application</a></li>
      <li><a href="../webprofile/create_a_hello_world_application.html">Create a Hello World application</a></li>
      <li><a href="../webprofile/create_a_jakarta_rest_service.html">Create a Jakarta REST service</a></li>
      <li><a href="../webprofile/create_a_pages_application.html">Create a Pages application</a></li>
      <li><a href="../webprofile/testing_with_junit5_and_playwright.html">Testing with JUnit 5 and Playwright</a></li>
      <li><a href="../webprofile/testing_with_our_container_image.html">Testing with our container image</a></li>
     </ul></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <div id="poweredBy">
              <div class="clear"></div>
    <div id="twitter" style="border:none; margin-top: 10px">
    <a href="https://twitter.com/piranha_cloud" class="twitter-follow-button" data-show-count="false" data-align="left" data-size="medium" data-show-screen-name="false" data-lang="en" data-dnt="true" >Follow piranha_cloud</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>
              <div class="clear"></div>
<span class="builtBy"></span>
            </div>
          </div>
        </header>
        <main id="bodyColumn" class="span10">
<section><a id="Run_a_web_application_on_CRaC"></a>
<h1>Run a web application on CRaC</h1>
<p>If you are looking to get CRaC-ing with Piranha Servlet you can follow along!</p>
<p><em>Make sure you are using a CRaC enabled JDK available from
<a href="https://github.com/CRaC/openjdk-builds/releases" class="externalLink">https://github.com/CRaC/openjdk-builds/releases</a></em></p>
<p>In 10 steps you will learn how to deploy CRaC with Piranha Servlet. They are:</p>
<ol style="list-style-type: decimal;">

<li>Create the Maven POM file</li>
<li>Add the hello.xhtml page</li>
<li>Add the HelloBean.java file</li>
<li>Add the web.xml file</li>
<li>Add the beans.xml file</li>
<li>Add an integration test</li>
<li>Test the application</li>
<li>Start the application</li>
<li>Create the checkpoint</li>
<li>Restart the application</li>
</ol><section><a id="Create_the_Maven_POM_file"></a>
<h2>Create the Maven POM file</h2>
<p>Create an empty directory to store your Maven project. Inside of that directory
create the <code>pom.xml</code> file with the content as below.</p>

<pre class="prettyprint"><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;project
    xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;cloud.piranha.guides.servlet&lt;/groupId&gt;
    &lt;artifactId&gt;crac&lt;/artifactId&gt;
    &lt;version&gt;24.5.0-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;war&lt;/packaging&gt;
    &lt;name&gt;Run a web application on Piranha Servlet with CRaC&lt;/name&gt;
    &lt;properties&gt;
        &lt;!-- dependencies --&gt;
        &lt;junit.version&gt;5.11.0-M1&lt;/junit.version&gt;
        &lt;mojarra.version&gt;4.0.6&lt;/mojarra.version&gt;
        &lt;piranha.version&gt;24.4.0&lt;/piranha.version&gt;
        &lt;weld.version&gt;5.1.2.Final&lt;/weld.version&gt;
        &lt;!-- other --&gt;
        &lt;java.version&gt;21&lt;/java.version&gt;
        &lt;piranha.distribution&gt;servlet&lt;/piranha.distribution&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;!-- plugins --&gt;
        &lt;maven-compiler-plugin.version&gt;3.13.0&lt;/maven-compiler-plugin.version&gt;
        &lt;maven-failsafe-plugin.version&gt;3.2.5&lt;/maven-failsafe-plugin.version&gt;
        &lt;maven-war-plugin.version&gt;3.4.0&lt;/maven-war-plugin.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;!-- compile --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.glassfish&lt;/groupId&gt;
            &lt;artifactId&gt;jakarta.faces&lt;/artifactId&gt;
            &lt;version&gt;${mojarra.version}&lt;/version&gt;
            &lt;scope&gt;compile&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.weld.servlet&lt;/groupId&gt;
            &lt;artifactId&gt;weld-servlet-shaded&lt;/artifactId&gt;
            &lt;version&gt;${weld.version}&lt;/version&gt;
            &lt;scope&gt;compile&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!-- runtime --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;cloud.piranha.extension&lt;/groupId&gt;
            &lt;artifactId&gt;piranha-extension-redhat-weld&lt;/artifactId&gt;
            &lt;version&gt;${piranha.version}&lt;/version&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!-- test --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;
            &lt;version&gt;${junit.version}&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;
            &lt;version&gt;${junit.version}&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-params&lt;/artifactId&gt;
            &lt;version&gt;${junit.version}&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;build&gt;
        &lt;finalName&gt;crac&lt;/finalName&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;cloud.piranha.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;piranha-maven-plugin&lt;/artifactId&gt;
                &lt;version&gt;${piranha.version}&lt;/version&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;id&gt;pre-integration-test&lt;/id&gt;
                        &lt;phase&gt;pre-integration-test&lt;/phase&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;start&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                    &lt;execution&gt;
                        &lt;id&gt;post-integration-test&lt;/id&gt;
                        &lt;phase&gt;post-integration-test&lt;/phase&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;stop&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
                &lt;configuration&gt;
                    &lt;distribution&gt;servlet&lt;/distribution&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;${maven-compiler-plugin.version}&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;release&gt;${java.version}&lt;/release&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
                &lt;version&gt;${maven-failsafe-plugin.version}&lt;/version&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;integration-test&lt;/goal&gt;
                            &lt;goal&gt;verify&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
                &lt;version&gt;${maven-war-plugin.version}&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;failOnMissingWebXml&gt;false&lt;/failOnMissingWebXml&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
</code></pre></section><section><a id="Add_the_Hello_XHTML_file"></a>
<h2>Add the Hello XHTML file</h2>
<p>Add the helloworld.xhtml file in the <code>src/main/webapp</code> directory.</p>

<pre class="prettyprint"><code class="language-html">&lt;?xml version='1.0' encoding='UTF-8' ?&gt;

&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;

&lt;html lang=&quot;en&quot;
      xmlns=&quot;http://www.w3.org/1999/xhtml&quot;
      xmlns:f=&quot;jakarta.faces.core&quot;
      xmlns:h=&quot;jakarta.faces.html&quot;
      xmlns:pt=&quot;jakarta.faces.passthrough&quot;&gt;
    &lt;h:head&gt;
        &lt;title&gt;Jakarta Faces application&lt;/title&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;/&gt;
    &lt;/h:head&gt;
    &lt;h:body&gt;
        &lt;div&gt;Jakarta Faces application&lt;/div&gt;
        &lt;h:form&gt;
                &lt;h:outputText value=&quot;#{helloBean.hello}&quot;/&gt;
            &lt;br/&gt;
        &lt;/h:form&gt;
    &lt;/h:body&gt;
&lt;/html&gt;
</code></pre></section><section><a id="Add_the_HelloBean.java_file"></a>
<h2>Add the HelloBean.java file</h2>
<p>Add the HelloBean.java file in the <code>src/main/java/hello</code> directory.</p>

<pre class="prettyprint"><code class="language-java">package hello;

import jakarta.enterprise.context.RequestScoped;
import jakarta.inject.Named;

@Named(value = &quot;helloBean&quot;)
@RequestScoped
public class HelloBean {

    private String hello = &quot;Hello from CRaC!&quot;;

    public String getHello() {
        return hello;
    }

    public void setHello(String hello) {
        this.hello = hello;
    }
}
</code></pre></section><section><a id="Add_the_web.xml_file"></a>
<h2>Add the web.xml file</h2>
<p>Add the web.xml file in the <code>src/main/webapp/WEB-INF</code> directory.</p>

<pre class="prettyprint"><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;web-app version=&quot;3.0&quot; xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; 
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; 
         xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;Faces Servlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;jakarta.faces.webapp.FacesServlet&lt;/servlet-class&gt;
        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;Faces Servlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;*.xhtml&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</code></pre></section><section><a id="Add_the_beans.xml_file"></a>
<h2>Add the beans.xml file</h2>
<p>Add the beans.xml file in the <code>src/main/webapp/WEB-INF</code> directory.</p>

<pre class="prettyprint"><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;beans xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/beans_2_0.xsd&quot;
       bean-discovery-mode=&quot;all&quot;&gt;
&lt;/beans&gt;
</code></pre></section><section><a id="Add_an_integration_test"></a>
<h2>Add an integration test</h2>
<p>As we want to make sure the application gets tested before we release an
integration test is added which will be executed as part of the build.</p>
<p>We'll add the integration test to the <code>src/test/java</code> directory.</p>

<pre class="prettyprint"><code class="language-java">package hello;

import java.net.URI;
import java.net.http.HttpClient;
import static java.net.http.HttpClient.Redirect.ALWAYS;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.net.http.HttpResponse.BodyHandlers;
import java.time.Duration;
import static org.junit.jupiter.api.Assertions.assertTrue;
import org.junit.jupiter.api.Test;

public class HelloIT {

    @Test
    public void testHelloXhtml() throws Exception {
        HttpClient client = HttpClient
                .newBuilder()
                .connectTimeout(Duration.ofSeconds(60))
                .followRedirects(ALWAYS)
                .build();
        HttpRequest request = HttpRequest
                .newBuilder(new URI(&quot;http://localhost:8080/crac/hello.xhtml&quot;))
                .build();
        HttpResponse&lt;String&gt; response = client.send(request, BodyHandlers.ofString());
        assertTrue(response.body().contains(&quot;Hello from CRaC!&quot;));
    }
}
</code></pre></section><section><a id="Test_the_application"></a>
<h2>Test the application</h2>
<p>The application is setup to use JUnit to do integration testing using the
Piranha Maven plugin so when you are building the application it will also
execute an integration test validating the web application works.</p>
<p>To build and test the application execute the following command:</p>

<pre class="prettyprint"><code class="language-bash">  mvn install
</code></pre></section><section><a id="Deploy_the_application"></a>
<h2>Deploy the application</h2>
<p>To deploy your application you will need 2 pieces.</p>
<ol style="list-style-type: decimal;">

<li>The Piranha Servlet runtime JAR.</li>
<li>The WAR file you just produced.</li>
</ol>
<p>For the WAR file see the <code>target</code> directory. For the Piranha Servlet
distribution go to Maven Central. And then the following command line will
deploy your application:</p>

<pre class="prettyprint"><code class="language-bash">  java -XX:CRaCCheckpointTo=cr -jar piranha-dist-servlet.jar --enable-crac --write-pid --war-file crac.war &amp;
</code></pre></section><section><a id="Create_the_checkpoint"></a>
<h2>Create the checkpoint</h2>
<p>You have your application currently running so now it is time to create a
checkpoint.</p>
<p>To ask the JVM to create a checkpoint use the command line below:</p>

<pre class="prettyprint"><code class="language-bash">  jcmd piranha-dist-servlet.jar JDK.checkpoint
</code></pre>
<p>The application will exit and the chechkpoint files are in the <code>cr</code> directory.</p></section><section><a id="Restart_the_application"></a>
<h2>Restart the application</h2>
<p>To restart the application for the checkpoint you can use the following command
line:</p>

<pre class="prettyprint"><code class="language-bash">  java -XX:CRaCRestoreFrom=cr
</code></pre></section><section><a id="Conclusion"></a>
<h2>Conclusion</h2>
<p>As you can see using CRaC with Piranha Servlet is matter of the right JDK and
the right command line switch.</p></section><section><a id="References"></a>
<h2>References</h2>
<ol style="list-style-type: decimal;">

<li><a href="https://wiki.openjdk.org/display/crac/Main" class="externalLink">CRaC Project</a></li>
</ol>
<p><a href="../">Up</a></p></section></section>        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p class="pull-right">©      2024
<a href="https://piranha.cloud">Piranha Cloud</a>
</p>
        </div>
      </div>
    </footer>
  </body>
</html>
